!function(t,n){"object"==typeof exports&&t.require?module.exports=n(require("underscore"),require("d3")):"function"==typeof define&&define.amd?define(["underscore","d3"],function(a,e){return n(a||t._,e||t.d3)}):n(_,d3)}(this,function(t,n){function a(a){function r(t,a,e){n.keys(a).forEach(function(n){t[n]=function(r){if(!arguments.length)return a[n];var i=a[n];return a[n]=r,Nn[n].call(Vn,{value:r,previous:i}),e[n].call(Vn,{value:r,previous:i}),t}})}function i(){l(),b(),an.enableCarving!==!1&&(Z(),$())}function s(){var t=({x:"M 0 "+(yn()+28)+" L "+pn()+" "+(yn()+28),y:"M 0 "+yn()+" L "+0+" 0"},{x:"translate(0,"+gn()+")",y:"translate(0, 0)"}),n={x:function(){return"translate("+xn()/2+","+dn()+")"},y:function(){return"translate("+pn()+","+gn()/2+") rotate(90)"}};return null!==sn.select(".axis").node()?l():(["x","y"].forEach(function(a){var e=sn.append("g").attr("class",a+"axis axis");o(a),e.append("g").attr("class","ticks").attr("transform",t[a]).call(Cn[a]),e.append("text").style("text-anchor","middle").attr("class","axis_label").attr("transform",n[a]).text(an.axisLabel[a])}),void 0)}function o(t){var a={y:[0,-1*xn()],x:[0,0]},e=sn.select("."+t+"axis.axis");e.select(".categorical_ticks").remove();var r=n.format(".4r"),i=w(hn[t].domain())&&!E(hn[t].domain())?r:null;if("c"===an.dataType[t]){var s=e.append("g").attr("class","categorical_ticks"),o=hn[t].range();Cn[t].tickSize(a[t][0]);var l=hn[t].range(),c=(hn[t].rangeExtent()[1]-hn[t].rangeExtent()[0])/l.length,u=c/2,f=s.selectAll("line").data(o);"y"==t?f.enter().append("line").style("stroke","#888").style("stroke-width","2px").attr("x1",0).attr("x2",xn()).attr("y1",function(t){return t-u}).attr("y2",function(t){return t-u}):f.enter().append("line").style("stroke","#888").style("stroke-width","2px").attr("x1",function(t){return t+u}).attr("x2",function(t){return t+u}).attr("y1",0).attr("y2",gn())}else Cn[t].tickSize(a[t][1]);Cn[t].tickFormat(i)}function l(){["y","x"].forEach(function(t){var n=sn.select("."+t+"axis.axis");vn[t]=hn[t].copy(),"c"===an.dataType[t]&&vn[t].domain(hn[t].domain().map(function(n){return c(n,t)})),n.select(".ticks").transition().duration(Fn).call(Cn[t].scale(vn[t])),o(t)})}function c(t,n){return n in an.axisValueDictionary?t in an.axisValueDictionary[n]?an.axisValueDictionary[n][t]:t:t}function u(){var t=sn.select(".yaxis"),n=sn.select(".xaxis");t.select(".axis_label").text(an.axisLabel.y),n.select(".axis_label").text(an.axisLabel.x)}function f(){an.axisDomain.y=t.isArray(an.axisDomain.y)?an.axisDomain.y:"",an.axisDomain.x=t.isArray(an.axisDomain.x)?an.axisDomain.x:""}function d(n){n.attr("d",Mn(0).size(An)()).style("fill-opacity",function(n){return t.isUndefined(n.splits_on_x)?.8:en(n.splits_on_x)}).style("stroke-width","0px").call(x).transition().duration(Fn).attr("transform",function(t){return"translate("+hn.x(t[an.axisKey.x])+","+hn.y(t[an.axisKey.y])+")"});var a=ln.select(".data_labels").selectAll(".data_totals").data([],String);a.exit().remove()}function p(a){function e(t){"undefined"===t&&(t=void 0);var n=Sn.indexOf(t),a=A/2,e=(n-a)*(_+E*A);return Math.round(e)}function r(t){return t[3]*b}function i(t){return s(t)?"#fff":"#000"}function s(){return!1}function o(t){t.style("fill",i).style("visibility",function(t){return+t[3]<=0?"hidden":null}).attr("transform",function(t){return"translate("+(hn.x(t[0])+e(t[2]))+","+(hn.y(t[1])+h-r(t)+20*s(t))+")"})}var l={};hn.x.domain().forEach(function(t){l[t]={},hn.y.domain().forEach(function(n){l[t][n]={},Sn.forEach(function(a){l[t][n][a]=0})})});var c=hn.x.domain().length*hn.y.domain().length*Sn.length,u=Array.apply(null,new Array(hn.y.domain().length)).map(function(){return 0}),f=new Array(c);qn.forEach(function(t,n){u[n]=l[t[an.axisKey.x]][t[an.axisKey.y]][String(t[an.colorBy.label])]++});var d=c-1;n.keys(l).forEach(function(t){n.keys(l[t]).forEach(function(a){n.keys(l[t][a]).forEach(function(n){f[d--]=[t,a,n,l[t][a][n]]})})});var p="y",y=hn[p].range(),g=(hn[p].rangeExtent()[1]-hn[p].rangeExtent()[0])/y.length,h=g/2,v="x",m=hn[v].range(),k=(hn[v].rangeExtent()[1]-hn[v].rangeExtent()[0])/m.length,b=(g-25)/(n.max(u)+1),_=k/2/Sn.length,w=_/2,E=_/Sn.length,A=Sn.length-1;a.style("fill-opacity",.8).call(x).transition().duration(Fn).attr("d","M 0 0 L "+w+" 0 L "+w+" -"+b+" L -"+w+" -"+b+" L -"+w+" 0 L 0 0").attr("transform",function(t,n){return"translate("+(hn.x(t[an.axisKey.x])+e(String(t[an.colorBy.label])))+","+(hn.y(t[an.axisKey.y])+h-u[n]*b)+")"});var B=t.groupBy(f,function(t){return t[0]+"_"+t[1]}),T=t.map(B,function(n){return t.chain(n).sortBy(function(t){return t[3]}).last(3).value()}),M=t.flatten(T,!0),S=ln.select(".data_labels").selectAll(".data_totals").data(M,String);S.enter().append("text").attr("class","data_totals").style("text-anchor","middle").text(function(t){return t[3]}).attr("transform",function(t){return"translate("+(hn.x(t[0])+e(t[2]))+","+hn.y(t[1])+")"}),S.transition().duration(Fn).call(o),S.exit().remove()}function y(){var t,a,e="n"===an.dataType.x?"x":"y",r=hn[e].domain(),i="x"===e?"y":"x",s=(hn[i].domain().map(String),hn[i].range()),o=(hn[i].rangeExtent()[1]-hn[i].rangeExtent()[0])/s.length,l=n.scale.linear(),c={},u=n.keys(mn);n.keys(mn[u[0]]),u.length&&(u.forEach(function(t){c[t]={},n.keys(mn[t]).forEach(function(n){c[t][n]=q(mn[t][n],r)})}),t=n.values(c).map(function(t){return n.max(n.values(t).map(function(t){return n.max(t,function(t){return t[1]})}))}),a=n.max(t),l=n.scale.linear().domain([0,a]).range([-1*o/2,o/2-10]),"y"===i&&l.range([o/2,-1*o/2+10]));var f=ln.select(".kde_surface").selectAll(".kde_group").data(u,String);f.enter().append("g").attr("class","kde_group"),f.transition().duration(Fn).attr("transform",function(t){return"translate("+("y"===i?"0, ":"")+hn[i](t)+("x"===i?", 0":"")+")"});var d=f.selectAll(".kde_ensemble").data(function(t){return n.entries(c[t])},function(t){return t.key});d.enter().append("g").attr("class","kde_ensemble").style("fill",function(t){return an.colorFn(t.key)}).style("fill-opacity",.3);var p=d.selectAll(".kde_plot").data(function(t){return[t.value]},function(t){return t.key}),y=p.enter().append("g").attr("class","kde_plot");y.append("path").attr("class","kde_line").style("fill","none").style("stroke","black"),y.append("path").attr("class","kde_area").style("stroke","none"),d.call(g),p.transition().select(".kde_line").duration(Fn).attr("d",n.svg.line()[i](function(t){return l(t[1])})[e](function(t){return hn[e](t[0])}).interpolate("basis")),p.transition().select(".kde_area").duration(Fn).attr("d",n.svg.area().interpolate("basis")[e](function(t){return hn[e](t[0])})[i+"0"](l(0))[i+"1"](function(t){return l(t[1])})),p.exit().remove(),d.exit().remove(),f.exit().remove()}function x(t){return t.style("fill",function(t){return an.colorFn(String(t[an.colorBy.label]))}).style("fill-opacity",function(t){return an.highlight&&an.highlight.length?an.highlight===String(t[an.colorBy.label])?.8:0:.5}).style("stroke",null),t}function g(t){t.style("fill-opacity",function(t){return an.highlight&&an.highlight.length?an.highlight===t.key?.8:0:.3})}function h(){var t=ln.select(".data").selectAll(".data_point").data([],String);t.exit().remove()}function v(){var t=ln.select(".data_labels").selectAll(".data_totals").data([],String);t.exit().remove()}function m(){var t=ln.select(".kde_surface").selectAll("g").data([],String);t.exit().remove()}function k(){"cc"!==an.dataType.mix&&v(),"nc"!==an.dataType.mix&&"cn"!==an.dataType.mix&&m(),"nn"!==an.dataType.mix&&"cc"!==an.dataType.mix&&h()}function b(){var t=ln.select(".data").selectAll(".data_point").data(qn,function(t){return t[an.id]});t.enter().append("path").attr("class","data_point").style("fill","#fff").style("stroke","#fff"),t.exit().transition().duration(Fn/2).style("fill-opacity",0).style("stroke-opacity",0).remove(),k(),"nn"===an.dataType.mix?d(t):"n"==an.dataType.x^"n"==an.dataType.y?y(t):"cc"===an.dataType.mix&&p(t)}function _(n){return t.isArray(n)?n.length<=bn?!0:n.some(t.isString)?!0:!1:!1}function w(n){return n.every(t.isNumber)}function E(t){return t.every(function(t){return 0===t%1})}function A(n){return t.every(n,t.isFinite)}function B(){if(an.data.length<1)return console.log("Empty data array.  Nothing to plot."),void 0;var a=n.keys(an.data[0]);if(t.contains(a,an.axisKey.x)&&t.contains(a,an.axisKey.y)){var e=t.uniq(t.pluck(an.data,an.axisKey.x)),r=t.uniq(t.pluck(an.data,an.axisKey.y));an.dataType.x=_(e)?"c":"n",an.dataType.y=_(r)?"c":"n",qn=an.data,M(e,r)}else console.error("x or y coordinates not packaged in data")}function T(t,n){var a=t[0],e=t[1],r=e-a||1,i=r*(n-1);return[a-i,e+i]}function M(a,e){var r=t.pluck(qn,"splits_on_x");en=n.scale.linear().domain(n.extent(r)).range([.2,.9]);var i={x:[0,xn()],y:[gn(),0]},s={x:t.union(a,an.axisInsistCategoricalValues.x).sort(),y:t.union(e,an.axisInsistCategoricalValues.y).sort().reverse()};return["x","y"].forEach(function(t){if("c"===an.dataType[t])hn[t]=n.scale.ordinal().domain(s[t]).rangePoints(i[t],1),hn[t].invert=n.scale.ordinal().domain(hn[t].range()).range(s[t]),kn[t]=[];else{var a=an.axisDomain[t]||n.extent(s[t]),e=T(a,_n);hn[t]=n.scale.linear().domain(e).rangeRound(i[t])}}),an.dataType.mix=an.dataType.x+an.dataType.y,"nc"===an.dataType.mix?S("y","x"):"cn"===an.dataType.mix&&S("x","y"),l()}function S(n,a){mn={};var r=[],i=[],s={},o=hn[a].domain()[1]-hn[a].domain()[0],l=o/100,c=[],u={};hn[n].domain().forEach(function(o){if(s={},s[an.axisKey[n]]=o,i=t.where(an.data,s),r=t.pluck(i,an.axisKey[a]),mn[o]={},Sn.forEach(function(n){s={},s[an.colorBy.label]=Kn?+n:n,c=t.where(i,s),u[n]=t.pluck(c,an.axisKey[a])}),t.uniq(r).length<=bn);else{var f=e.stats.kde().sample(r).kernel(e.stats.kernel.gaussian),d=f.bandwidth()(r);if(l>d&&(f.bandwidth(l),d=l),Sn.length<=1)return mn[o].all=f,void 0;Sn.forEach(function(t){s={},s[an.colorBy.label]=t,u[t].length<1||(f=e.stats.kde().sample(u[t]).bandwidth(d).kernel(e.stats.kernel.gaussian),mn[o][t]=f)})}})}function K(a){if(Sn=an.colorBy.list&&an.colorBy.list.length?an.colorBy.list.map(String):[void 0],Kn=A(Sn)?!0:!1,t.isArray(an.colorBy.colors)&&an.colorBy.colors.length&&(nn=an.colorBy.colors),!a||a.value.label!==a.previous.label||0!==t.difference(a.value.list,a.previous.list).length){var e=Sn.length,r=t.first(nn,e)||nn[0];an.colorFn=e?n.scale.ordinal().domain(Sn).range(r):function(){return r}}}function D(){return Cn.y.scale(hn.y).tickSize(-1*xn()).ticks(5),Cn.x.scale(hn.x).tickSize(2).ticks(5),Vn}function q(a,e){var r=[],i=a.sample();if(t.isUndefined(e)&&(e=n.extent(i)),void 0===i)return[];var s=a.bandwidth()(i);return r=n.range(e[0]-2*s,e[1]+2*s,s),a(r)}function C(t,n){hn[n].invert(t),zn[n].span=t,$(),U(t,n)}function F(n,a){var e=hn[a].domain(),r=hn[a].rangeExtent();t.contains(kn[a],n)||kn[a].push(n);var i=t.difference(e,kn[a]),s=t.union(kn[a],i),o=(r[1]-r[0])/s.length;return i.length<=0?(zn[a].span=null,kn[a]=[],void 0):(hn[a].domain(s),hn[a].invert.range(s),zn[a].span=hn[a](n)-o/2*("x"===a?-1:1),void 0)}function L(n,a){if(t.contains(kn[a],n)){kn[a]=t.difference(kn[a],[n]);var e=kn[a].length,r=e?t.difference(hn[a].domain(),kn[a]):hn[a].domain(),i=e?t.union(kn[a],r):r,s=(hn[a].rangeExtent()[1]-hn[a].rangeExtent()[0])/i.length;hn[a].domain(i),hn[a].invert.range(i),zn[a].span=e?hn[a](kn[a][e-1])-s/2*("x"===a?-1:1):null}}function z(){["x","y"].forEach(function(t){kn[t]="n"===an.dataType[t]?null:[],N(t)})}function N(n){t.isNull(zn[n].span)||(zn[n].span=null,$(),U(null,n))}function V(n){z();var a=n.value;a.forEach(function(n,a){var e=an.axisKey.x===a?"x":an.axisKey.y===a?"y":"";if(!t.isEmpty(e))if(t.isArray(n.values))n.values.forEach(function(t){F(t,e)});else if(t.isFinite(n.high)&&t.isFinite(n.low)){var r=hn[e].domain();n.high===r[1]?C(n.low,e):C(n.high,e)}}),i()}function I(){var n,a,e,r;["x","y"].forEach(function(i){if(void 0!==an.splits[i]){if(r=zn[i].data_array=an.splits[i].bins,r.length<1||void 0===r[0]||r[0].length<1)return console.error("invalid split bins in axis: "+i),void 0;a=zn[i].data_array.length,n=an.splits[i].low+.5*an.splits[i].binsize,e=n+(a-1)*an.splits[i].binsize;var s=r.map(function(t,a){return n+an.splits[i].binsize*a}),o=hn[i].domain(),l=o[0],c=o[1];r=[];var u=0,f=[];s.forEach(function(t,n){t>=l&&c>=t&&(f[u]=t,r[u]=zn[i].data_array[n],u++)}),a=f.length,n=f[0],e=f[a-1],zn[i].data_array=a>0?r:void 0,zn[i].vis={attr:"x"===i?"d":"stroke",fn:"x"===i?Mn:Dn,"default":"x"===i?Mn(0)():"transparent"},t.isUndefined(zn[i].data_array)||P(i,a,n,e)}})}function P(t,a,e,r){var i=zn[t].data_array;zn[t].opacityScale=n.scale.linear().domain(n.extent(i)).rangeRound([.3,.9]),zn[t].colorScale=n.scale.linear().domain(n.extent(i)).range(["#FFEDA0","#F03B20"]),zn[t].binScale=n.scale.linear().domain([0,a-1]).rangeRound([hn[t](e),hn[t](r)])}function R(){if(null===sn.select(".split_labels").node()){var t=sn.append("g").attr("class","split_labels");t.append("text").attr("class","x").attr("text-anchor","middle").attr("dy","1em").text(""),t.append("text").attr("class","y").attr("text-anchor","right").attr("dx","0.1em").text("")}}function U(t,a){var e=n.format(".3f");if(null===t)return sn.select(".split_labels ."+a).text(""),void 0;var r={x:"x"===a?t:0,y:"y"===a?t:0};sn.select(".split_labels ."+a).text(e(hn[a].invert(t))).attr("transform","translate("+r.x+","+r.y+")")}function Z(){["x","y"].forEach(function(a){var e=n.select("."+a+".split_group").node();t.isNull(e)&&on.append("g").attr("class",""+a+" split_group"),"n"===an.dataType[a]?J(a):G(a)})}function j(){["x","y"].forEach(O)}function O(t){n.select("."+t+".split_group").selectAll("."+t+".split_pointer").transition().duration(Fn).style("stroke-opacity",0).remove()}function X(t){t.style("fill","#eee").style("fill-opacity",.3).style("stroke","#888").style("stroke-width",2)}function Y(t,n){var a=(hn[n].domain(),hn[n].range()),e=(hn[n].rangeExtent()[1]-hn[n].rangeExtent()[0])/a.length-10;"x"===n?t.attr("transform",function(t){return"translate("+(hn[n](t)-e/2)+",0)"}).attr("x",0).attr("width",e).attr("y",-12).attr("height",10):t.attr("transform",function(t){return"translate(4,"+(hn[n](t)-e/2+10)+")"}).attr("x",0).attr("width",10).attr("y",0).attr("height",e)}function G(a){var e=on.select("."+a+".split_group");"y"===a&&e.attr("transform",function(){return"translate("+xn()+",0)"});var r=hn[a].domain(),s=e.selectAll("rect").data(r,String);s.enter().append("rect").call(Y,a).call(X).on("mouseover",function(){n.select(this).style("fill-opacity",1)}).on("mouseout",function(){n.select(this).style("fill-opacity",.3)}).on("click",function(n){t.contains(kn[a],n)?L(n,a):F(n,a),i()}),s.transition().duration(Fn).call(Y,a),s.exit().remove()}function H(t,n){var a=hn[n].range();"x"===n?t.attr("x",a[0]).attr("width",a[1]-a[0]).attr("y",-10).attr("height",10):t.attr("x",0).attr("width",10).attr("y",0).attr("height",a[0]-a[1])}function J(t){var a=on.select("."+t+".split_group");"y"===t&&a.attr("transform",function(){return"translate("+(xn()+4)+",10)"});var e=a.selectAll("rect").data(["ZZZ"],String),r=("y"===t)+0;e.enter().append("rect").call(H,t).call(X).on("mouseover",function(){var a=n.mouse(this)[r];null===kn[t]&&C(a,t)}).on("mousemove",Q(t)).on("mouseout",function(){null===kn[t]&&N(t)}).on("click",function(){var e=n.mouse(this)[r];C(e,t),null!==kn[t]?(O(t),kn[t]=null):(kn[t]=e,W(a,t,e))}),e.exit().remove()}function Q(t){return function(){var a=n.mouse(this)["x"===t?0:1];null===kn[t]&&C(a,t)}}function W(t,n,a){"x"===n?t.append("path").attr("class",n+" split_pointer").attr("transform","translate("+a+",0)").attr("d",function(){return"M0,-10v10"}).style("stroke","#cc6432").style("stroke-width",4).style("fill","#cc6432"):t.append("path").attr("class",n+" split_pointer").attr("transform","translate(0,"+a+")").attr("d",function(){return"M0,0h10"}).style("stroke","#cc6432").style("stroke-width",4).style("fill","#cc6432")}function $(){var a=0,e=[[a,a,zn.x.span?zn.x.span-a:xn(),zn.y.span?zn.y.span-a:gn()],[zn.x.span?zn.x.span:xn(),a,zn.x.span?xn()-zn.x.span+a:0,zn.y.span?zn.y.span-a:gn()],[a,zn.y.span?zn.y.span:gn(),zn.x.span?zn.x.span-a:xn(),zn.y.span?gn()-zn.y.span+a:0],[zn.x.span?zn.x.span:xn(),zn.y.span?zn.y.span:gn(),zn.x.span?xn()-zn.x.span+a:0,zn.y.span?gn()-zn.y.span+a:0]];t.isNull(zn.x.span)&&t.isNull(zn.y.span)&&(e=[]);var r=cn.selectAll(".partition").data(e);r.enter().append("rect").attr("class","partition").attr("x",function(t){return t[0]}).attr("y",function(t){return t[1]}).attr("width",function(t){return t[2]}).attr("height",function(t){return t[3]}).style("fill",function(t,n){return an.partitionColors[n]}).style("fill-opacity",.3).style("stroke","none").style("stroke-opacity","0.6").style("stroke-width",4).on("mouseover",function(){n.selectAll(".partition").style("stroke","none"),n.select(this).style("stroke","#22D")}).on("mouseout",function(){var t=n.event.relatedTarget;n.select(t).classed("data_point")||"line"==t.nodeName||n.select(this).style("stroke","none")}).on("click",function(n){var a={};if(!t.isNull(zn.x.span))if(a[an.axisKey.x]={},"n"===an.dataType.x){var e={low:hn.x.invert(n[0]),high:hn.x.invert(n[2]+n[0])};a[an.axisKey.x]=t.clone(e)}else{var r=hn.x.range(),i=t.filter(r,function(t){return t>=n[0]&&t<=n[0]+n[2]});a[an.axisKey.x]={values:i.map(hn.x.invert)}}if(!t.isNull(zn.y.span))if(a[an.axisKey.y]={},"n"===an.dataType.y){var s={low:hn.y.invert(n[1]+n[3]),high:hn.y.invert(n[1])};a[an.axisKey.y]=t.clone(s)}else{var o=hn.y.range(),l=o.filter(function(t){return t>=n[1]&&t<=n[1]+n[3]});a[an.axisKey.y]={values:l.map(hn.y.invert)}}un.partitioncomplete(a)}),r.attr("x",function(t){return t[0]}).attr("y",function(t){return t[1]}).attr("width",function(t){return t[2]}).attr("height",function(t){return t[3]}),r.exit().transition().duration(100).attr("fill-opacity",0).remove()}var tn=a||{},nn=["#71C560","#9768C4","#98B8B8","#4F473D","#C1B14C","#B55381"],an={width:500,height:400,margin:{top:15,bottom:15,left:30,right:10},radius:4,dataType:{x:"n",y:"n",mix:"nn"},data:{x:[],y:[]},id:"id",axisDomain:{x:"",y:""},axisLabel:{x:"X Axis",y:"Y Axis"},axisValueDictionary:{x:{},y:{}},axisKey:{x:"x",y:"y"},axisInsistCategoricalValues:{x:[],y:[]},highlight:null,colorFn:function(){return nn[0]},colorBy:{label:"",list:[],colors:nn},clear:!0,enableCarving:!1,splitColor:"#C1573B",splits:{},partition:{},partitionColors:["#98B8B8","#4F473D","#C1B14C","#B55381"]};t.extend(an,tn);var en,rn,sn,on,ln,cn,un=n.dispatch.apply(this,["render","resize","highlight","brush","partitioncomplete"].concat(n.keys(an))),fn=function(){return an.width-an.margin.right-an.margin.left},dn=function(){return an.height-an.margin.top-an.margin.bottom},pn=function(){return fn()-wn.right-wn.left},yn=function(){return dn()-wn.top-wn.bottom},xn=function(){return pn()-20},gn=function(){return yn()-20},hn={x:n.scale.ordinal(),y:{}},vn={x:hn.x.copy(),y:{}},mn={x:null,y:null},kn={x:null,y:null},bn=4,_n=1.04,wn={top:15,bottom:15,left:30,right:20},En=["square","circle","cross","diamond","triangle-down","triangle-up"],An=Math.pow(an.radius,2),Bn=n.svg.symbol().size(An).type(En[0]),Tn=n.scale.ordinal().domain([0,5]).range(En),Mn=t.compose(Bn.type,Tn),Sn=[],Kn=!1,Dn=function(t){return Ln[t]},qn=[],Cn={x:n.svg.axis().orient("bottom"),y:n.svg.axis().orient("left")},Fn=300,Ln=["red","green","black"],zn={x:{},y:{}},Nn=n.dispatch.apply(this,n.keys(an)).on("radius",function(){An=Math.pow(an.radius,2)}).on("data",function(){console.log("carve: data loaded")}).on("colorBy",K).on("splits",I).on("partition",V).on("axisLabel",u).on("axisDomain",f),Vn=function(t){t=Vn.selection=n.select(t),D(),Vn.svg=t.append("div").attr("class","cv_wrapper").append("svg").attr("class","cv").attr("width",an.width).attr("height",an.height),Vn.canvas=t.select("div").append("canvas").attr("class","cv").style("position","absolute").attr("width",xn()).attr("height",gn()).style("left",wn.left+an.margin.left+"px").style("top",wn.top+an.margin.top+"px").style("z-index",-180);var a=Vn.svg.append("defs");a.append("svg:clipPath").attr("id","plot_clip").append("svg:rect").attr("id","clip-rect").attr("x","0").attr("y","0").attr("width",xn()).attr("height",gn()),a.append("svg:clipPath").attr("id","viewbox_clip").append("svg:rect").attr("x","0").attr("y","0").attr("width",fn()).attr("height",dn()),sn=Vn.svg.append("g").attr("class","label_surface").attr("transform","translate("+(wn.left+an.margin.left+10)+","+(wn.top+an.margin.top+10)+")");var e=Vn.svg.append("svg").attr("clip","url(#viewbox_clip)").attr("overflow","hidden").attr("x",an.margin.left).attr("y",an.margin.top);rn=e.append("g").attr("transform","translate("+wn.left+","+wn.top+")"),cn=rn.append("g").attr("transform","translate(10,10)").attr("class","partition_surface");var r=e.append("g").attr("transform","translate("+wn.left+","+wn.top+")");return on=r.append("g").attr("transform","translate(10,0)").attr("class","split_surface"),ln=r.append("g").attr("transform","translate(10,10)").attr("clip-path","url(#plot_clip)"),ln.append("g").attr("class","kde_surface"),ln.append("g").attr("class","data"),ln.append("g").attr("class","data_labels"),K(),Vn};return Vn.toString=function(){return"cv: ("+n.keys(an.data[0]).length+" total) , "+an.data.length+" rows"},Vn.state=an,r(Vn,an,un),n.rebind(Vn,un,"on"),Vn.render=function(){return B(),void 0!==Cn.y.scale()&&s(),qn.length&&b(),t.isObject(zn)&&an.enableCarving&&(z(),j(),Z(),R()),an.clear=!1,this},Vn.resize=function(){return Vn.svg.attr("height",yn()).attr("width",pn()).attr("transform","translate("+an.margin.left+","+an.margin.top+")"),this},Vn}var e={stats:{}};return e.ascending=function(t,n){return t-n},e.EULER=.5772156649015329,e.expm1=function(t){return 1e-5>t&&t>-1e-5?t+.5*t*t:Math.exp(t)-1},e.functor=function(t){return"function"==typeof t?t:function(){return t}},e.stats.kernel={uniform:function(t){return 1>=t&&t>=-1?.5:0},triangular:function(t){return 1>=t&&t>=-1?1-Math.abs(t):0},epanechnikov:function(t){return 1>=t&&t>=-1?.75*(1-t*t):0},quartic:function(t){if(1>=t&&t>=-1){var n=1-t*t;return.9375*n*n}return 0},triweight:function(t){if(1>=t&&t>=-1){var n=1-t*t;return 35/32*n*n*n}return 0},gaussian:function(t){return 1/Math.sqrt(2*Math.PI)*Math.exp(-.5*t*t)},cosine:function(t){return 1>=t&&t>=-1?Math.PI/4*Math.cos(Math.PI/2*t):0}},e.stats.mean=function(t){var n=t.length;if(0===n)return 0/0;for(var a=0,e=-1;++e<n;)a+=(t[e]-a)/(e+1);return a},e.stats.variance=function(t){var n=t.length;if(1>n)return 0/0;if(1===n)return 0;for(var a=e.stats.mean(t),r=-1,i=0;++r<n;){var s=t[r]-a;i+=s*s}return i/(n-1)},e.stats.quantiles=function(t,n){t=t.slice().sort(e.ascending);var a=t.length-1;return n.map(function(n){if(0===n)return t[0];if(1===n)return t[a];var e=1+n*a,r=Math.floor(e),i=e-r,s=t[r-1];return 0===i?s:s+i*(t[r]-s)})},e.stats.iqr=function(t){var n=e.stats.quantiles(t,[.25,.75]);return n[1]-n[0]},e.stats.bandwidth={nrd0:function(t){var n,a=Math.sqrt(e.stats.variance(t));return(n=Math.min(a,e.stats.iqr(t)/1.34))||(n=a)||(n=Math.abs(t[1]))||(n=1),.9*n*Math.pow(t.length,-.2)},nrd:function(t){var n=e.stats.iqr(t)/1.34;return 1.06*Math.min(Math.sqrt(e.stats.variance(t)),n)*Math.pow(t.length,-0.2)}},e.stats.kde=function(){function t(t){var e=r.call(this,a);return t.map(function(t){for(var r=-1,i=0,s=a.length;++r<s;)i+=n((t-a[r])/e);return[t,i/e/s]})}var n=e.stats.kernel.gaussian,a=[],r=e.stats.bandwidth.nrd;return t.kernel=function(a){return arguments.length?(n=a,t):n},t.sample=function(n){return arguments.length?(a=n,t):a},t.bandwidth=function(n){return arguments.length?(r=e.functor(n),t):r},t},a.version="0.0.9",a});